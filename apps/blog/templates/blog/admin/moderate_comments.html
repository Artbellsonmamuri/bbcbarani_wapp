{% extends 'admin/base_site.html' %}

{% block title %}Comment Moderation - Bible Baptist Church CMS{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1>Comment Moderation</h1>

    {% if comments %}
    <form method="post">
        {% csrf_token %}

        <!-- Bulk Actions -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <button type="submit" name="action" value="approve" class="btn btn-success">
                            <i class="fas fa-check"></i> Approve Selected
                        </button>
                        <button type="submit" name="action" value="reject" class="btn btn-danger">
                            <i class="fas fa-times"></i> Reject Selected
                        </button>
                        <button type="submit" name="action" value="spam" class="btn btn-warning">
                            <i class="fas fa-ban"></i> Mark as Spam
                        </button>
                    </div>
                    <div>
                        <label class="form-check-label">
                            <input type="checkbox" id="select-all" class="form-check-input"> Select All
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Comments List -->
        <div class="row">
            {% for comment in comments %}
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <input type="checkbox" name="comment_ids" value="{{ comment.id }}" class="form-check-input me-2">
                                <strong>{{ comment.get_author_name }}</strong>
                                {% if comment.is_guest_comment %}
                                    <span class="badge bg-info">Guest</span>
                                {% endif %}
                            </div>
                            <small class="text-muted">{{ comment.created_at|date:"M d, Y g:i A" }}</small>
                        </div>
                    </div>
                    <div class="card-body">
                        <p>{{ comment.content|linebreaks }}</p>

                        <div class="small text-muted">
                            <p><strong>On:</strong> <a href="{{ comment.blog_post.get_absolute_url }}">{{ comment.blog_post.title }}</a></p>
                            {% if comment.guest_email %}
                                <p><strong>Email:</strong> {{ comment.guest_email }}</p>
                            {% endif %}
                            {% if comment.guest_website %}
                                <p><strong>Website:</strong> <a href="{{ comment.guest_website }}">{{ comment.guest_website }}</a></p>
                            {% endif %}
                            <p><strong>IP:</strong> {{ comment.ip_address }}</p>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="btn-group">
                            <button type="button" class="btn btn-success btn-sm approve-single" 
                                    data-comment-id="{{ comment.id }}">Approve</button>
                            <button type="button" class="btn btn-danger btn-sm reject-single" 
                                    data-comment-id="{{ comment.id }}">Reject</button>
                            <button type="button" class="btn btn-warning btn-sm spam-single" 
                                    data-comment-id="{{ comment.id }}">Spam</button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </form>
    {% else %}
    <div class="text-center py-5">
        <h4>No pending comments</h4>
        <p class="text-muted">All caught up! No comments awaiting moderation.</p>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Select all checkbox
    document.getElementById('select-all').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('input[name="comment_ids"]');
        checkboxes.forEach(cb => cb.checked = this.checked);
    });

    // Individual action buttons
    document.querySelectorAll('.approve-single, .reject-single, .spam-single').forEach(button => {
        button.addEventListener('click', function() {
            const commentId = this.getAttribute('data-comment-id');
            const action = this.classList.contains('approve-single') ? 'approve' :
                          this.classList.contains('reject-single') ? 'reject' : 'spam';

            // Create hidden form for single action
            const form = document.createElement('form');
            form.method = 'post';
            form.innerHTML = `
                {% csrf_token %}
                <input type="hidden" name="action" value="${action}">
                <input type="hidden" name="comment_ids" value="${commentId}">
            `;
            document.body.appendChild(form);
            form.submit();
        });
    });
});
</script>
{% endblock %}
